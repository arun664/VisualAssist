<!DOCTYPE html>
<html>
<head>
    <title>Test Frame Rate Limiting</title>
</head>
<body>
    <h1>Test Frame Rate Limiting (1 FPS)</h1>
    <div id="log"></div>
    <button onclick="testFrameRateLimiting()">Test Frame Rate Limiting</button>
    <button onclick="checkProcessingStats()">Check Processing Stats</button>
    
    <script>
        function addLog(message) {
            const div = document.createElement('div');
            div.textContent = new Date().toLocaleTimeString() + ': ' + message;
            document.getElementById('log').appendChild(div);
            console.log(message);
        }
        
        function testFrameRateLimiting() {
            addLog('Testing frame rate limiting functionality...');
            
            // Test the WebRTC offer to establish connection
            testWebRTCConnection();
        }
        
        async function testWebRTCConnection() {
            try {
                addLog('ðŸ”— Testing backend connection...');
                
                // Test backend health
                const healthResponse = await fetch('http://localhost:8000/health');
                const healthData = await healthResponse.json();
                addLog('âœ… Backend health: ' + JSON.stringify(healthData.components));
                
                // Test WebRTC offer
                addLog('ðŸ“¤ Sending WebRTC offer...');
                const offerResponse = await fetch('http://localhost:8000/webrtc/offer', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        client_id: 'test_frame_rate_limiting',
                        type: 'offer',
                        sdp: 'mock_sdp_for_frame_rate_test'
                    })
                });
                
                const offerResult = await offerResponse.json();
                addLog('âœ… WebRTC offer result: ' + offerResult.status);
                
                // Check processing stats
                setTimeout(() => {
                    checkProcessingStats();
                }, 2000);
                
            } catch (error) {
                addLog('âŒ Connection test failed: ' + error.message);
            }
        }
        
        async function checkProcessingStats() {
            try {
                addLog('ðŸ“Š Checking processing statistics...');
                
                const statsResponse = await fetch('http://localhost:8000/webrtc/processing_stats');
                const statsData = await statsResponse.json();
                
                if (statsData.status === 'success') {
                    const stats = statsData.stats;
                    addLog('ðŸ“ˆ Processing Stats:');
                    addLog(`   Target FPS: ${stats.target_fps}`);
                    addLog(`   Active Clients: ${stats.active_clients}`);
                    
                    for (const [clientId, clientStats] of Object.entries(stats.clients)) {
                        addLog(`   Client ${clientId}:`);
                        addLog(`     Last processed: ${clientStats.last_processed.toFixed(2)}s ago`);
                        addLog(`     Processing time: ${clientStats.processing_time.toFixed(3)}s`);
                        addLog(`     Effective FPS: ${clientStats.effective_fps.toFixed(2)}`);
                    }
                    
                    // Verify frame rate limiting is working
                    if (stats.target_fps === 1.0) {
                        addLog('âœ… Frame rate limiting configured correctly (1 FPS target)');
                    } else {
                        addLog('âš ï¸ Frame rate limiting not set to 1 FPS');
                    }
                } else {
                    addLog('âŒ Failed to get processing stats: ' + statsData.error);
                }
                
            } catch (error) {
                addLog('âŒ Stats check failed: ' + error.message);
            }
        }
        
        // Auto-run test after page load
        setTimeout(() => {
            addLog('ðŸš€ Starting automatic frame rate limiting test...');
            testFrameRateLimiting();
        }, 1000);
    </script>
</body>
</html>