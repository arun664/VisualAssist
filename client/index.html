<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Navigation Assistant - Client Device</title>
    <link rel="stylesheet" href="client-styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>AI Navigation Assistant</h1>
            <p class="subtitle">Client Device - Sensor Capture</p>
        </header>

        <!-- Authentication Modal -->
        <div id="authModal" class="auth-modal">
            <div class="auth-content">
                <h2>üîê Backend Authentication</h2>
                <p>Enter the access code to connect to the backend service:</p>
                <div class="auth-form">
                    <input type="password" id="authCodeInput" placeholder="Enter access code" maxlength="50">
                    <button id="authSubmitBtn" class="auth-btn">Connect</button>
                </div>
                <div id="authError" class="auth-error hidden">Invalid access code. Please try again.</div>
                <div class="auth-note">
                    <small>üõ°Ô∏è Secure connection required for AI navigation services</small>
                </div>
            </div>
        </div>

        <!-- Media Preview Section -->
        <div class="media-preview">
            <div class="video-container">
                <video id="localVideo" autoplay muted playsinline></video>
                <div class="video-overlay" id="videoOverlay">
                    <span>Camera not active</span>
                </div>
            </div>
            <div class="audio-indicator">
                <div class="audio-level" id="audioLevel"></div>
                <span id="audioStatus">Microphone: Off</span>
            </div>
        </div>
        
        <!-- Navigation Guidance Display -->
        <div class="navigation-guidance" id="navigationGuidance">
            <div class="guidance-title">
                <span class="guidance-icon">üß≠</span>
                <span>Navigation Guidance</span>
            </div>
            <div class="guidance-message" id="guidanceMessage">
                Start streaming to receive navigation assistance
            </div>
            <div class="guidance-pulse" id="guidancePulse"></div>
        </div>

        <!-- Step 1: Connection Management -->
        <div class="connection-section">
            <h3>Step 1: Backend Connection</h3>
            <div id="backendDetectionStatus"></div>
            <div class="server-config">
                <label for="serverUrl">Backend Server URL:</label>
                <input type="text" id="serverUrl" value="" placeholder="Auto-detecting backend server...">
            </div>
            <div class="connection-controls">
                <button id="connectBtn" class="control-btn connect-btn" disabled>
                    Connect to Backend
                </button>
                <button id="disconnectBtn" class="control-btn disconnect-btn" disabled>
                    Disconnect
                </button>
                <button id="testWebRTCBtn" class="control-btn test-btn">
                    Test WebRTC Connectivity
                </button>
            </div>
        </div>

        <!-- Step 2: Media Controls -->
        <div class="media-controls">
            <h3>Step 2: Enable Camera and Microphone</h3>
            <div class="permission-controls">
                <button id="requestCameraBtn" class="control-btn camera-btn">
                    <span class="btn-icon">üìπ</span>
                    Enable Camera
                </button>
                <button id="switchCameraBtn" class="control-btn camera-switch-btn" disabled>
                    <span class="btn-icon">üîÑ</span>
                    Switch Camera
                </button>
                <button id="requestMicBtn" class="control-btn mic-btn">
                    <span class="btn-icon">üé§</span>
                    Enable Microphone
                </button>
            </div>
            
            <!-- Step 3: Streaming Controls -->
            <h3>Step 3: Start Streaming</h3>
            <div class="stream-controls">
                <button id="startStreamBtn" class="control-btn primary" disabled>
                    Start Streaming to Backend
                </button>
                <button id="stopStreamBtn" class="control-btn secondary" disabled>
                    Stop Streaming to Backend
                </button>
            </div>
        </div>

        <!-- Status Indicators -->
        <div class="status-section">
            <div class="status-grid">
                <div class="status-item">
                    <div class="status-indicator" id="cameraIndicator"></div>
                    <span>Camera</span>
                    <span id="cameraStatus">Not Ready</span>
                </div>
                <div class="status-item">
                    <div class="status-indicator" id="micIndicator"></div>
                    <span>Microphone</span>
                    <span id="micStatus">Not Ready</span>
                </div>
                <div class="status-item">
                    <div class="status-indicator" id="connectionIndicator"></div>
                    <span>WebRTC</span>
                    <span id="connectionStatus">Disconnected</span>
                </div>
                <div class="status-item">
                    <div class="status-indicator" id="streamIndicator"></div>
                    <span>Stream</span>
                    <span id="streamStatus">Inactive</span>
                </div>
            </div>
        </div>

        <!-- Optional Biometric Section -->
        <div class="biometric-section" id="biometricSection" style="display: none;">
            <h3>Biometric Sensors (Optional)</h3>
            <div class="biometric-controls">
                <button id="enableBiometricBtn" class="control-btn biometric-btn">
                    <span class="btn-icon">‚ù§Ô∏è</span>
                    Enable Heart Rate
                </button>
                <div class="biometric-status">
                    <span id="heartRateValue">-- BPM</span>
                    <span id="biometricStatus">Not Available</span>
                </div>
            </div>
        </div>

        <!-- Debug Information -->
        <div class="debug-section" id="debugSection">
            <details>
                <summary>Debug Information</summary>
                <div class="debug-content">
                    <div class="debug-item">
                        <strong>Browser Support:</strong>
                        <span id="browserSupport">Checking...</span>
                    </div>
                    <div class="debug-item">
                        <strong>Connection State:</strong>
                        <span id="connectionState">new</span>
                    </div>
                    <div class="debug-item">
                        <strong>ICE State:</strong>
                        <span id="iceState">new</span>
                    </div>
                    <div class="debug-item">
                        <strong>Last Error:</strong>
                        <span id="lastError">None</span>
                    </div>
                </div>
            </details>
        </div>
    </div>
    <script src="../config.js"></script>
    <script src="client.js"></script>
    <script src="fix-navigation.js"></script>
    <script>
        // Auto-configure backend URL on page load
        document.addEventListener('DOMContentLoaded', () => {
            const serverUrlInput = document.getElementById('serverUrl');
            const backendUrl = window.AI_NAV_CONFIG?.getBackendUrl?.();
            
            if (backendUrl) {
                serverUrlInput.value = backendUrl;
                console.log('üîß Auto-configured backend URL:', backendUrl);
            } else {
                serverUrlInput.placeholder = 'Enter your backend server URL (e.g., http://localhost:8000)';
                console.log('üîß No backend URL configured - user must enter manually');
            }
            
            // Add test mode link
            const debugSection = document.getElementById('debugSection');
            if (debugSection) {
                const testModeLink = document.createElement('div');
                testModeLink.style.marginTop = '10px';
                testModeLink.innerHTML = '<a href="?test=true" style="color: #4a90e2; text-decoration: underline;">Enable Navigation Test Mode</a>';
                debugSection.appendChild(testModeLink);
            }
        });
    </script>
</body>
</html>