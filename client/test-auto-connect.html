<!DOCTYPE html>
<html>
<head>
    <title>Test Auto-Connect</title>
</head>
<body>
    <h1>Test Automatic Connection on Start Streaming</h1>
    <div id="log"></div>
    <button onclick="simulateStartStreaming()">Simulate Start Streaming</button>
    
    <script>
        function addLog(message) {
            const div = document.createElement('div');
            div.textContent = new Date().toLocaleTimeString() + ': ' + message;
            document.getElementById('log').appendChild(div);
            console.log(message);
        }
        
        function simulateStartStreaming() {
            addLog('Testing automatic connection on start streaming...');
            
            // Create a mock NavigationClient to test the logic
            const mockClient = {
                cameraEnabled: true,
                micEnabled: true,
                isConnected: false,
                videoStream: { getVideoTracks: () => [{ kind: 'video' }] },
                audioStream: { getAudioTracks: () => [{ kind: 'audio' }] },
                
                updateStreamStatus: (status) => addLog('Stream status: ' + status),
                
                async connectToServer() {
                    addLog('Connecting to server...');
                    
                    try {
                        const response = await fetch('http://localhost:8000/health');
                        if (!response.ok) {
                            throw new Error('Server not responding');
                        }
                        
                        this.isConnected = true;
                        addLog('✅ Successfully connected to backend');
                        return true;
                    } catch (error) {
                        addLog('❌ Connection failed: ' + error.message);
                        throw error;
                    }
                },
                
                async createPeerConnection() {
                    addLog('Creating WebRTC peer connection...');
                    // Mock implementation
                    return true;
                },
                
                async createAndSendOffer() {
                    addLog('Creating and sending WebRTC offer...');
                    
                    try {
                        const response = await fetch('http://localhost:8000/webrtc/offer', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                client_id: 'test_client',
                                type: 'offer',
                                sdp: 'mock_sdp_data'
                            })
                        });
                        
                        const result = await response.json();
                        addLog('✅ WebRTC offer successful: ' + JSON.stringify(result));
                        return true;
                    } catch (error) {
                        addLog('❌ WebRTC offer failed: ' + error.message);
                        throw error;
                    }
                }
            };
            
            // Test the new startStreaming logic
            testStartStreaming(mockClient);
        }
        
        async function testStartStreaming(client) {
            try {
                client.updateStreamStatus('Starting...');
                
                // Automatically connect to backend if not already connected
                if (!client.isConnected) {
                    addLog('Not connected to server - connecting automatically...');
                    client.updateStreamStatus('Connecting to backend...');
                    
                    try {
                        await client.connectToServer();
                        addLog('Successfully connected to backend');
                    } catch (error) {
                        addLog('Failed to connect to backend: ' + error.message);
                        client.updateStreamStatus('Connection failed');
                        return;
                    }
                }
                
                // Set up WebRTC peer connection
                addLog('Setting up WebRTC connection...');
                await client.createPeerConnection();
                await client.createAndSendOffer();
                
                client.updateStreamStatus('Active');
                addLog('✅ Streaming started successfully with automatic connection!');
                
            } catch (error) {
                addLog('❌ Failed to start streaming: ' + error.message);
                client.updateStreamStatus('Error');
            }
        }
    </script>
</body>
</html>